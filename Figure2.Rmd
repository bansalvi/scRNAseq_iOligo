---
title: "Figure2"
date: "2024-07-03"
output: 
  github_document:
    toc: true
    toc_depth: 2
---

## Load libraries

```{r, warning=FALSE, eval=TRUE, message=FALSE}
.libPaths( c( "/data/Common_Folder/R/Single_cell_packages/", .libPaths()) )
library("SCpubr")
library(Seurat)
library(patchwork)
library(gridExtra)
library(ggplot2)
library(future)
library(dplyr)
library(SeuratData)
library(glmGamPoi, lib.loc = "/data/nasser/R/packages_nasser/")
library(harmony)
library(enrichR)
library(gprofiler2)
library(data.table) 
library(speckle, lib.loc = "/data/Common_Folder/R/Single_cell_packages/")
library(ggpubr)
library(data.table)
library(dplyr)
library(openxlsx)

```

## Load the RNA-Seq data

```{r}
pd = readRDS("/data/nasser/Manuscript/Strict_threshold/processedobject/ODC35_woClus8_subclust3_res0.15_NK")
pd
```

```{r pressure, echo=FALSE, warning=FALSE, include=FALSE}
## UMAP visualisation
Idents(pd) <- "CellType"
rushmore_palette <- c("#6677B3", "#99CC66", "#66C2A5", "#FFCC66", "#FF9933", "#FF9999", "#C85200", "#B3B3B3", "#999999", "#666666")

table(Idents(pd))
p=DimPlot(pd, reduction = "umap", label = T, pt.size = 0.5, cols = rushmore_palette) 
p
```

##Find subcluster of iPPC cluster with res0.15

```{r, warning=FALSE, message=TRUE}
#Find sub-cluster of iPPC with res = 0.15. 
Idents(pd) <- "sub.cluster"
pd.sub <- FindSubCluster(object = pd, resolution = 0.15, cluster= "3", graph.name = "SCT_nn", subcluster.name = "sub.cluster.iPPC") 

pd.sub
```

## Adding cluster cell type names

```{r}
### Naming clusters ###
Idents(pd.sub) <- "sub.cluster.iPPC"
new.cluster.ids <- c("iPPC_1","iNL2", "iOPC", "iCEP", "iNL1", "iRGC", "iPPC_0" , "iODC", "iINPC", "iPPC_2")
names(new.cluster.ids) <- levels(pd.sub)
pd.sub <- RenameIdents(pd.sub, new.cluster.ids)
pd.sub@meta.data$CellType <- as.character(Idents(pd.sub))

Idents(pd.sub) <- "CellType"
table(Idents(pd.sub))

#save object
#pathto.outData = "/data/nasser/Manuscript/processedobject/"
#saveRDS(pd.sub,file=paste0(pathto.outData,"ODC35_woClus8_subclust3_res0.15_NK"))

```

```{r, include=FALSE}
#load object prepared above
pd.sub = readRDS("/data/nasser/Manuscript/Strict_threshold/processedobject/ODC35_woClus8_subclust3_res0.15_NK")
```

```{r, include=FALSE}
#Find markers in olig_subset 
ippc_sub = subset(pd.sub, idents = c("iPPC_0", "iPPC_1", "iPPC_2"))
```

## Figure 2-A: Feature plot

```{r}
p <- SCpubr::do_NebulosaPlot(ippc_sub,
                        features = c("PDGFRA","LRRK2"), joint=T)
#pathto.outPlots = "/data/nasser/Manuscript/plots/figure2/"
#outname = "figure2_d_"
#png(paste0(pathto.outPlots,outname,"SCpubR_JointDensity_PDGFRA_LRRK2.png"), width=5000, height=3000, res = 300)
p
#dev.off()
```

## Figure 2-B : UMAP visualisation of clusters

```{r}
Idents(pd.sub) <- "CellType"

rushmore_palette <- c("#47537d","#8492c2", "#d1d6e8", "#99CC66", "#66C2A5", "#FFCC66", "#FF9933", "#FF9999", "#C85200", "#B3B3B3")
levels(pd.sub) <- c('iPPC_0','iPPC_1','iPPC_2',"iNL2", "iOPC", "iCEP", "iNL1", "iRGC", "iODC", "iINPC")

#pathto.outPlots = "/data/nasser/Manuscript/plots/figure2/"
#outname = "figure2_a_"

#png(paste0(pathto.outPlots,outname,"UMAP_subcluster3.png"), width=1500, height=1000,res = 300)
p=DimPlot(object = pd.sub, reduction = "umap", label = F, pt.size = 0.5, cols = rushmore_palette) 
#dev.off()

p

```

<!-- ## Supplementary table S2 - excluding sample 8 + iPPC cell types -->

<!-- ```{r} -->

<!-- # Extract metadata -->

<!-- md <- pd.sub@meta.data %>% as.data.table() -->

<!-- # Calculate cell numbers and percentages for each cluster -->

<!-- cell_counts_f <- md[, .N, by = c("CellType")] -->

<!-- total_cells <- sum(cell_counts_f$N) -->

<!-- cell_counts_f$Percentage <- (cell_counts_f$N / total_cells) * 100 -->

<!-- # Calculate cell numbers and percentages for each cluster and mutation -->

<!-- cell_counts_fm <- md[, .N, by = c("CellType", "Mutation")] -->

<!-- total_cells <- sum(cell_counts_fm$N) -->

<!-- cell_counts_fm$Percentage <- (cell_counts_fm$N / total_cells) * 100 -->

<!-- # Pivot table to get LRRK2 and HC percentages -->

<!-- cell_counts_pivot <- dcast(cell_counts_fm, CellType ~ Mutation, value.var = "N") -->

<!-- cell_counts_pivot[, `:=`(LRRK2_Percentage = (LRRK2 / total_cells) * 100, HC_Percentage = (HC / total_cells) * 100)] -->

<!-- # Combine the data into the final table -->

<!-- final_table <- merge(cell_counts_f, cell_counts_pivot, by = "CellType") -->

<!-- final_table <- final_table[, .(CellType, N, Percentage, LRRK2, LRRK2_Percentage, HC, HC_Percentage)] -->

<!-- # Rename columns to match the desired structure -->

<!-- colnames(final_table) <- c("Celltype", "N", "Percentage", "LRRK2", "Percentage", "HC", "Percentage") -->

<!-- # Create a new workbook and add a worksheet -->

<!-- wb <- createWorkbook() -->

<!-- addWorksheet(wb, "Sheet1") -->

<!-- # Write the data to the worksheet -->

<!-- writeData(wb, "Sheet1", final_table, startRow = 3, startCol = 2) -->

<!-- # Add bold titles with the same font size and style -->

<!-- header_style <- createStyle(fontSize = 12, fontName = "Calibri", textDecoration = "bold") -->

<!-- addStyle(wb, "Sheet1", header_style, rows = 3, cols = 2:8, gridExpand = TRUE) -->

<!-- pathto.outTable <- "/data/nasser/Manuscript/table/Supplementary Tables/" -->

<!-- saveWorkbook(wb,  file = paste0(pathto.outTable,"Sup2_excl8_ippc.xlsx"), overwrite = TRUE) -->

<!-- ``` -->

### Figure 2-B : UMAP for oligodendrolineage subcluster

```{r}
olig_sub = subset(pd.sub, idents = c("iPPC_0", "iPPC_1", "iPPC_2", "iODC", "iOPC"))
levels(olig_sub) <- c('iPPC_0','iPPC_1','iPPC_2', "iOPC", "iODC")



#pathto.outPlots = "/data/nasser/Manuscript/plots/figure2/"
#outname = "figure2_a_"
rushmore_palette <- c("#47537d","#8492c2", "#d1d6e8","#66C2A5", "#C85200")

#png(paste0(pathto.outPlots,outname,"UMAP_olig_lineage.png"), width=1500, height=1000,res = 300)
DimPlot(object = olig_sub, reduction = "umap", label = F, pt.size = 0.5, cols = rushmore_palette) 
#dev.off()
```

#Find all markers for all clusters to identify genes that are markers for specific clusters

```{r, include=TRUE}

test.markers_default <- FindAllMarkers(pd.sub, only.pos= TRUE)
test.markers_default <- test.markers_default[test.markers_default$p_val_adj < 0.05, ]

head(test.markers_default)


#pathto.outTable= "/data/nasser/Manuscript/table/Figure2/"
#pathto.outsupTable= "/data/nasser/Manuscript/table/Supplementary Tables/"

#outname = "all_clusters_"
#write.table(test.markers_default, file=paste0(pathto.outTable,outname,"findallmarkers_default.csv"), sep=",", quote = F)

#write.table(test.markers_all, file=paste0(pathto.outTable,outname,"findallmarkers_minpct02.csv"), sep=",", quote = F)
#write.table(test.markers_all, file=paste0(pathto.outsupTable,outname,"findallmarkers_minpct02.csv"), sep=",", quote = F)

```

## Figure 2-C: Heatmap of markers for oligodendroglial clusters

```{r}
# Filter for specific clusters
clusters_of_interest <- c('iPPC_0','iPPC_1','iPPC_2', 'iOPC', 'iODC')

top_markers <- test.markers_default %>%
    dplyr::filter(cluster %in% clusters_of_interest) %>%
    group_by(cluster) %>%
    dplyr::filter(avg_log2FC > 1) %>%
    slice_head(n = 5) %>%
    ungroup()

# Set factor levels for the clusters of interest
top_markers$cluster <- factor(top_markers$cluster, levels = clusters_of_interest)

# Arrange by cluster for plotting
top_markers <- top_markers %>%
    arrange(cluster)

# Display the top markers for verification
top_markers

# Ensure the Seurat object is set to the correct identity class
Idents(pd.sub) <- "CellType"

# Plot the heatmap for the selected features (genes)
DoHeatmap(olig_sub, features = top_markers$gene, size = 2) + 
    scale_fill_gradientn(colors = c("blue", "white", "orange"))


```

```{r}


test.markers_olig <- FindAllMarkers(ippc_sub, only.pos= TRUE, min.pct =0.1, logfc.threshold=0.1, min.diff.pct = 0.2)
test.markers_olig <- test.markers_olig[test.markers_olig$p_val_adj < 0.05, ]


#pathto.outTable = "/data/nasser/Manuscript/table/Figure2/"
#pathto.outsupTable= "/data/nasser/Manuscript/table/Supplementary Tables/"
#outname = "ippc_clusters_"
#write.table(test.markers_olig, file=paste0(pathto.outTable,outname, "findallmarkers_minpco0.1_log0.1_diffpct0.2.csv"), sep=",", quote = F)
#write.table(test.markers_olig, file=paste0(pathto.outsupTable,outname, "findallmarkers_minpco0.1_log0.1_diffpct0.2.csv"), sep=",", quote = F)


```

<!-- ```{r} -->

<!-- # top markers for ippc cluster -->

<!-- top_markers_ippc <- test.markers_olig %>% -->

<!--     group_by(cluster) %>% -->

<!--     dplyr::filter(avg_log2FC > 1) %>% -->

<!--     slice_head(n = 8) %>% -->

<!--     ungroup() -> top10 -->

<!-- levels_order <- c('iPPC_0','iPPC_1','iPPC_2') -->

<!-- top_markers_ippc$cluster <- factor(top_markers_ippc$cluster, levels = levels_order) -->

<!-- top10 <- top_markers_ippc %>% -->

<!--     arrange(cluster) -->

<!-- ippc_sub@active.ident <- factor(x = ippc_sub@active.ident, levels = levels_order) -->

<!-- #do_ExpressionHeatmap(ippc_sub, features = top10$gene, cluster= T, font.size    = 8, flip=F,viridis.direction=-1, ) -->

<!-- #pathto.outPlots = "/data/nasser/Manuscript/plots/figure2/" -->

<!-- #outname = "figure2_c_" -->

<!-- #png(paste0(pathto.outPlots,outname,"heatmap_subcluster3_new.png"), width=2000, height=2000,res = 300) -->

<!-- DoHeatmap(ippc_sub, features = top10$gene, size = 4, disp.max = 2)+ scale_fill_gradientn(colors = c("blue", "white", "orange")) -->

<!-- #dev.off() -->

<!-- p -->

<!-- ``` -->

## Speckle analysis on cell type mutation composition

Calculate fischer exact test on cell type mutation composition. difference in the distribution of cell counts across different cell types (clusters) between the "HC" (Healthy Control) and "LRRK2" group

```{r}

#pathto.outTable <- "/data/nasser/Manuscript/table/Supplementary Tables/"

Idents(pd.sub) <- "CellType"
p=propeller(clusters=pd.sub$CellType, sample=pd.sub$SampleID, group=pd.sub$Mutation)
p
#write.table(p, file = paste0(pathto.outTable,"S2_speckle_ippc_new.csv"), quote = F, sep = ",", row.names = T)

```

## Figure 2-F: Celltype composition boxplot

```{r, warning=FALSE}
ggplot(pd@meta.data, aes(x=CellType, fill=Mutation)) + 
  geom_bar(position = "fill") + geom_text(stat = 'count', aes(label = ..count..), position = position_fill(vjust = 0.5)) + RotatedAxis() + theme_classic()
```

## Cell cycle scoring

```{r}
levels(pd.sub) <- c('iPPC_0','iPPC_1','iPPC_2',"iNL2", "iOPC", "iCEP", "iNL1", "iRGC", "iODC", "iINPC")

table(Idents(pd.sub))

#Cell cycle scoring 
data.filt <- CellCycleScoring(
  object = pd.sub,
  g2m.features = cc.genes$g2m.genes,
  s.features = cc.genes$s.genes
)
VlnPlot(data.filt, features = c("S.Score","G2M.Score")) #higher G2M =  more actively dividing cells and higher S = more actively replicating DNA for following divisions


#pathto.outPlots = "/data/nasser/Manuscript/plots/figure2/"
#outname = "figure2_b_"
##png(paste0(pathto.outPlots,outname,"S.Score.png"), width=5000, height=3000, res = 300)
#VlnPlot(data.filt, features = c("S.Score"), split.by = "Mutation") 
#png(paste0(pathto.outPlots,outname,"G2M.Score.png"), width=5000, height=3000, res = 300)
#VlnPlot(data.filt, features = c("G2M.Score"), split.by = "Mutation") 

#dev.off()
```

<!-- #Enriched expression of cell cycle related genes -->

<!-- ```{r} -->

<!-- #Enriched expressio of cell cycle related genes -->

<!-- genes_dotPlot <- rev(unique(c( "PDGFRA", "LRRK2", "TOP2A","MKI67"))) -->

<!-- #levels(oligo_subset) <- c('2_0','2_2','3_0', '3_1', '3_2','3_3','6') -->

<!-- # Filter the dataframe if they are in findmarkers -->

<!-- genes_in_test_markers <- test.markers %>% -->

<!--   filter(gene %in% genes_dotPlot) -->

<!-- genes_in_test_markers -->

<!-- # Extract unique genes from the dataframe -->

<!-- unique_genes <- unique(genes_in_test_markers$gene) -->

<!-- # Check which genes in genes_dotPlot are present in unique_genes -->

<!-- genes_present <- genes_dotPlot %in% unique_genes -->

<!-- # Determine if all genes are present -->

<!-- all_present <- all(genes_present) -->

<!-- # Identify missing genes if any -->

<!-- missing_genes <- genes_dotPlot[!genes_present] -->

<!-- # Output the result -->

<!-- if (all_present) { -->

<!--   print(TRUE) -->

<!-- } else { -->

<!--   print(FALSE) -->

<!--   print(missing_genes) -->

<!-- } -->

<!-- #pathto.outPlots = "/data/nasser/Manuscript/plots/figure2/" -->

<!-- #outname = "figure2_b_" -->

<!-- #png(paste0(pathto.outPlots,outname,"Dotplot_markers.png"), width=5000, height=3000, res = 300) -->

<!-- DotPlot(pd.sub, assay = "RNA", features = (genes_dotPlot), dot.min = 0.3, cols=c( "blue", "red")) + scale_colour_gradient2(low="steelblue", mid="lightgrey", high="red") +RotatedAxis() -->

<!-- #dev.off() -->

<!-- ``` -->
